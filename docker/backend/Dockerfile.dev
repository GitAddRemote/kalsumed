# 1. base image & workspace root
FROM node:20-alpine
WORKDIR /usr/src

# 2. pnpm setup
RUN corepack enable && corepack prepare pnpm@latest --activate

# 3. copy monorepo manifests + backend manifest
COPY package.json pnpm-lock.yaml turbo.json pnpm-workspace.yaml ./
COPY apps/backend/package.json apps/backend/

# 4. install *all* deps (including @nestjs/cli hoisted into the workspace)
RUN pnpm install --frozen-lockfile

# 5. switch into backend & copy only build-time files
WORKDIR /usr/src/apps/backend
COPY apps/backend/tsconfig.json tsconfig.json
COPY apps/backend/src src/

# 6. build
RUN pnpm run build

# 7. dev entrypoint
CMD ["pnpm", "--filter", "@kalsumed/backend", "dev"]
