FROM node:20-alpine

WORKDIR /usr/src/apps/frontend

# Enable pnpm
RUN corepack enable && corepack prepare pnpm@10.14.0 --activate

# Copy only dependency manifests
COPY package.json pnpm-lock.yaml turbo.json pnpm-workspace.yaml ./
COPY apps/frontend/package.json apps/frontend/

# Install all deps (populates node_modules volume)
RUN pnpm install --frozen-lockfile

# Entrypoint: start Vite in watch/dev mode
CMD [ "sh", "-lc", "([ -d node_modules ] && [ \"$(ls -A node_modules)\" ]) || pnpm install --no-frozen-lockfile; pnpm --filter @kalsumed/frontend dev -- --host 0.0.0.0" ]
